<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
<script type="text/javascript">

$(document).ready(function() {
	buildMap();
	
});

function HexMapNode(x, y)
 {
    this.x = x;
    this.y = y;
    this.isWall = false;
    this.topNode = null;
    this.bottomNode = null;
    this.leftTopNode = null;
    this.rightTopNode = null;
    this.leftBottomNode = null;
    this.rightBottomNode = null;
    this.htmlElement = null;
    this.nodesUntilGoal = 9999;

    this.getId = function()
	{
		return "hex" + this.x + "-" + this.y;
	};
	this.getPos = function()
	{
		var actualX =   this.x*nodeSize*.75; 
		var actualY = (this.y*nodeSize) + (nodeSize/2)*(this.x%2);
		return [actualX, actualY];
		
	};
	this.getHexMapNodeFromDirection = function(direction)
	{
	    if(direction==0)
	            return this.topNode; 
	     if(direction==1)
	            return this.bottomNode;  
	     if(direction==2)
	            return this.leftTopNode;
	      if(direction==3)
	            return this.rightTopNode;
	      if(direction==4)
	            return this.leftBottomNode;
	       if(direction==5)
	            return this.rightBottomNode;
	    
	    return null;
	};
	this.getBestNeighbour = function()
	{
		var min = 9999;
		var bestNode = null;
		var nodeArray = [this.topNode,this.bottomNode,this.leftTopNode,this.rightTopNode,this.leftBottomNode,this.rightBottomNode];
		for(var i = 0; i < 6; i ++)
		{
			if(nodeArray[i]!=null && nodeArray[i].nodesUntilGoal < min)
			{
				bestNode = nodeArray[i];
				min = nodeArray[i].nodesUntilGoal;
			}
		}
	    
	    return bestNode;
	};
}

var hexMap = [[],[],[],[],[],[],[],[],[],[],[],[]]; 
var mapHeigtCount = 12;
var mapWidthCount = 12;
var nodeSize = 25;
var wallPlayerGoal = 'wall';
function buildMap()
{
    for(var i = 0; i <mapHeigtCount; i++)
    {
        for(var j=0; j< mapWidthCount; j++)
        {
            var newNode = new HexMapNode(j,i);
            hexMap[i].push(newNode);
			var node = ' <div id="'+ newNode.getId() + '"class="hex" style="left:'+ newNode.getPos()[0] + ';top:'+ newNode.getPos()[1] +';" onclick="nodeSelected(event);"> \
				<div class="nodesUntilGoalDiv" style="position:absolute;left:5px;top:5px;"></div>\
				<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="25" width="25" viewBox="0 0 100 100"> \
				<polygon points="4,50 25,4 75,4 96,50 75,96 25,96 4,50" fill="white" stroke="black" stroke-width="4"/></svg> \
				</div>';
			$('#mainDiv').append(node);
			newNode.htmlElement = $('#'+newNode.getId() );
            if(i!=0)
            {
                newNode.topNode = hexMap[i-1][j];
                hexMap[i-1][j].bottomNode = newNode;
            }
            if(j%2 == 0)
            {
                if(j!=0)
                {
                    newNode.leftBottomNode = hexMap[i][j-1];
                    hexMap[i][j-1].rightTopNode = newNode; 
                }
                if(j!=0 && i!=0)
                {
                    newNode.leftTopNode = hexMap[i-1][j-1];
                    hexMap[i-1][j-1].rightBottomNode = newNode; 
                }
                if(i!=0 && j< mapWidthCount)
                {
                    newNode.rightTopNode = hexMap[i-1][j+1];
                    hexMap[i-1][j+1].leftBottomNode = newNode; 
                }

            }
            else
            {
                if(j!=0)
                {
                    newNode.leftTopNode = hexMap[i][j-1];
                    hexMap[i][j-1].rightBottomNode = newNode; 
                }

            }
        }
    }
}

var goalNodes = [];
var playerNodes = [];

function buildDirectionalMap()
{ 
	
	var openSet = [];
	var closedSet = {};
	var closedCount = 0;
    //add goal nodes
    for(var i=0; i< goalNodes.length; i++)
    {
		var node = goalNodes[i];
		node.nodesUntilGoal = 0;
		openSet.push(node);
    }

        for(var i = 0; i < openSet.length; i++) 
		{
			var node = openSet[i];
			if(node!=null)
			{
				closedSet[node.getId()] = node;
				var openSetI = openSet.indexOf(node);
				openSet.splice(openSetI,1);
				i--;
	            for(var j = 0; j < 6; j++)
	            {
	                var neighbour = node.getHexMapNodeFromDirection(j);
	                if(neighbour!=null  && neighbour.isWall == false && closedSet[neighbour.getId()]==null && openSet.indexOf(neighbour) == -1)
	                {
						neighbour.nodesUntilGoal = node.nodesUntilGoal + 1;
						neighbour.htmlElement.find('.nodesUntilGoalDiv').html(neighbour.nodesUntilGoal);
						openSet.push(neighbour);
						
	                }
	                else if(neighbour!=null  && neighbour.isWall == true) 
	                {
	                     neighbour.nodesUntilGoal = 9999;
	                }
                
	            }
			}
        }

    
}

function nodeSelected(ev)
{
	var targetId = ev.target.id != '' ? ev.target.id: $(ev.target).parent().attr('id');
	targetId = targetId != '' ? targetId :  $(ev.target).parent().parent().attr('id');
	var patt1=/hex([0-9]*)-([0-9]*)/;
	var x = (targetId.match(patt1)[1]);
	var y = (targetId.match(patt1)[2]);
	var node = hexMap[y][x];
	if(wallPlayerGoal == 'wall')
	{
		if(node.isWall == false)
		{
			node.isWall = true;
			$("#"+ targetId).find('polygon').attr("fill","black");
		}
		else
		{
			node.isWall = false;
			$("#"+ targetId).find('polygon').attr("fill","white");
		}
	}
	else if(wallPlayerGoal == 'player')
	{
		$("#"+ targetId).find('polygon').attr("fill","blue");
		var index = playerNodes.indexOf(node);
		if(index== -1)
			playerNodes.push(node);
		else
			playerNodes.splice(index,1);
	}
	else if(wallPlayerGoal == 'goal')
	{
		$("#"+ targetId).find('polygon').attr("fill","green");
		var index = goalNodes.indexOf(node);
		if(index== -1)
			goalNodes.push(node);
		else
			goalNodes.splice(index,1);
	}
}

function changeType(ev)
{
	wallPlayerGoal = ev.target.value;
}

function start()
{
	buildDirectionalMap();
	console.log("build")
}

function start2()
{
	startAnimation();
}


function startAnimation()
{
	for(var i = 0; i < playerNodes.length; i++)
	{
		var current = playerNodes[i];
		var next = current.getBestNeighbour();
		current.htmlElement.find('polygon').attr("fill","white");
		next.htmlElement.find('polygon').attr("fill","blue");
		playerNodes[i]= next;
	}
	
    //window.setTimeout("startAnimation()", 50);
}

</script>
<style type="text/css">
.hex
{
	width:25px;
	height:25px;
	position:absolute;
}

</style>
</head>
<body>
<div >
	<div id="mainDiv" style="width:260px;height:320px;position:relative;">
	</div>
	<div  style="position:absolute;right:0px;left:auto;border:inset grey 4px">
		<span>  <input type="radio" checked="checked" name="nodeType" value="wall" onclick="changeType(event)"/>wall</span>
		<span>  <input type="radio" name="nodeType" value="player" onclick="changeType(event)"/>player</span>				
		<span>  <input type="radio" name="nodeType" value="goal" onclick="changeType(event)"/>goal</span>
		<button onclick="start();"> Start</button>
		<button onclick="start2();"> Start2</button>
		
		
	</div>
</div>

				
</body>
</html>
